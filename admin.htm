<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Portone</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="olliout.css">
    <link rel="stylesheet" href="loader.css">
</head>

<body style="background-color: CORAL;">
    <div class="container">
        <div class="inner-container">
            <br>
            <!-- Welcome card -->
            <div class="card text-center">
                <div class="card-body bg-transparent">
                    <h4 class="card-title">Amministrazione</h4>
                    <p class="card-text">Se sei qui per fare dei casini buona fortuna</p>
                    <p id="rtc"></p>
                    <a href="/index.htm" class="mt-2 btn btn-info" title="Magari funziona">Pagina Login</a>
                </div>
            </div>

            <br>

            <!-- Action selection-->
            <fieldset class="form-group">
                <div class="row">
                    <legend class="col-form-legend col-sm-2"><b>Sistema</b></legend>
                    <div class="btn-group col-sm-10" data-toggle="buttons">
                        <label class="btn btn-secondary">
                            <input type="radio" name="a" id="r1" autocomplete="off">Blocca</label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="a" id="r2" autocomplete="off">Svuota</label>
                        <label class="btn btn-secondary active">
                            <input type="radio" name="a" id="r3" autocomplete="off">Nuovo</label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="a" id="r4" autocomplete="off">Test</label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="a" id="r5" autocomplete="off">Keys</label>
                    </div>
                </div>
            </fieldset>

            <!-- Password time validity -->
            <fieldset class="form-group" id="timeval">
                <div class="row">
                    <legend class="col-form-legend col-sm-2"><b>Validità</b></legend>
                    <div class="btn-group col-sm-10" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                            <input type="radio" name="v" id="v1" value="21600" autocomplete="off">6 Ore</label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="v" id="v2" value="259200" autocomplete="off">3 Giorni</label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="v" id="v3" value="2592000" autocomplete="off">30 Giorni</label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="v" id="v4" value="31536000" autocomplete="off">1 Anno</label>
                    </div>
                </div>
            </fieldset>

            <form id="access" method="post">
                <!-- Text inputs -->
                <div class="form-group row">
                    <!-- Administrator inputs -->
                    <label for="key" class="mt-2 col-sm-2 col-form-label adminpassword">
                        <b>Master Password</b>
                    </label>
                    <div class="mt-2 col-sm-10 adminpassword">
                        <input type="password" class="form-control passwd" name="ak" id="key" placeholder="Chiave Admin" title="Mi raccomando">
                    </div>

                    <!-- User inputs -->
                    <label for="userkey" class="mt-2 col-sm-2 col-form-label userpassword">
                        <b>Password</b>
                    </label>
                    <div class="mt-2 col-sm-10 userpassword">
                        <input type="password" class="form-control passwd" name="k" id="userkey" placeholder="Chiave Utente" title="Mi raccomando">
                    </div>


                    <!-- Confirm button -->
                    <div class="mt-2 col-sm-12 text-center">
                        <button type="button" class="btn btn-success btn-lg btn-block" title="Daje" id="submit">Agisci</button>
                    </div>
                </div>
            </form>

            <ul class="list-group" id="list" type="hidden"></ul>
        </div>
    </div>

    <!-- Modal correctly completed -->
    <div class="modal fade" id="completed" tabindex="-1" role="dialog" aria-labelledby="thanksLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thanksLabel">Ottimo!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Le modifiche sono state attuate!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Fai dell'altro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal locked -->
    <div class="modal fade" id="locked" tabindex="-1" role="dialog" aria-labelledby="thanksLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thanksLabel">Sistema bloccato!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Dovrai sbloccarlo dinuovo perché qualcuno possa entrare
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Bene</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal forbidden -->
    <div class="modal fade" id="forbidden" tabindex="-1" role="dialog" aria-labelledby="thanksLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thanksLabel">Ahia!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Hai sbagliato a scrivere qualcosa, almeno spero
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Riprova</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal tooMany -->
    <div class="modal fade" id="tooMany" tabindex="-1" role="dialog" aria-labelledby="thanksLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thanksLabel">Malissimo!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Le credenziali sono state sbagliate troppe volte, devi aspettare un po' di tempo prima di riprovare
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Aspetterò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal generic -->
    <div class="modal fade" id="default" tabindex="-1" role="dialog" aria-labelledby="thanksLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thanksLabel">Boh?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Qualcosa è andato storto ma non saprei cosa
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-dismiss="modal">Vabbuò</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loader"></div>

    <!-- <script src="admin.js"></script> -->
    <script>
        res = [];
        $(function () {
            // Without these two lines any options has the property checked to true
            $('#r3')[0].checked = true;
            $('#v1')[0].checked = true;
            res = "add";
            // Modifing the visibility of the UI
            // elements depending on the desired action
            $('#r1').on('change', function () {
                $('.adminpassword').show();
                $('.userpassword').hide();
                $('#timeval').hide();
                $('#list').hide();
                res = "lock";
            });
            $('#r2').on('change', function () {
                $('.adminpassword').show();
                $('.userpassword').hide();
                $('#timeval').hide();
                $('#list').hide();
                res = "revokeAll";
            });
            $('#r3').on('change', function () {
                $('.adminpassword').show();
                $('.userpassword').show();
                $('#timeval').show();
                $('#list').hide();
                res = "add";
            });
            $('#r4').on('change', function () {
                $('.adminpassword').hide();
                $('.userpassword').show();
                $('#timeval').hide();
                $('#list').hide();
                res = "check";
            });
            $('#r5').on('change', function () {
                $('.adminpassword').show();
                $('.userpassword').hide();
                $('#timeval').hide();
                $('#list').show();
                res = "active";
            });

            $('.passwd').keydown(function (event) {
                var keyCode = (event.keyCode ? event.keyCode : event.which);
                if (keyCode == 13) {
                    $('#submit').trigger('click');
                }
            });

            $('#access').submit(function (e) {
                e.preventDefault();
            });

            //handle = null;
            $('#submit').click(function () {
                d = $('#access').find('input:visible').serialize();
                if ($('#r3')[0].checked)
                    d += '@' + (Math.floor(Date.now() / 1000) + parseInt($("input[name=v]:checked").val()));

                $.ajax({	// Send request
                    url: res,
                    method: "POST",
                    dataType: "text",
                    data: d,
                    timeout: 10000,
                    success: function (result) {
                        //console.log(result);
                        if (result.length > 0) { // Fill list
                            $('#list').empty() 
                            var entries = result.split('\n');
                            entries.forEach(e => {
                                if (e.length > 1) {// Double \n entries                                    
                                    var at = e.indexOf('@');
                                    var key = e.substr(2, at - 2);
                                    var d = new Date(e.substr(at + 1) * 1000);
                                    var date = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear() + " " + d.getHours() + ":" + d.getMinutes()
                                    $('#list').append(`<li class="list-group-item d-flex justify-content-between align-items-center">
                                                    ${key}
                                                    <span class="badge badge-primary badge-pill">${date}</span>
                                                    </li>`);
                                }
                            });
                            $('#list').show();
                            
                        } else {
                            $('#completed').modal();
                        }
                        $('#loader').hide();                        
                    },
                    error: function (result) {
                        $('#loader').hide();

                        switch (result.status) {
                            case 423:
                                $('#locked').modal();
                                break;
                            case 403:
                                $('#forbidden').modal();
                                break;
                            case 429:
                                $('#tooMany').modal();
                                break;
                            default:
                                $('#default').modal();
                                break;
                        }
                    }
                });
                //alert("Sent");                
                $('#loader').show();
            });

            // Getting RTC from system
            $.ajax({
                url: "epoch",
                method: "GET",
                dataType: "text",
                timeout: 10000,
                success: function (result) {
                    date = new Date(result * 1000);
                    $('#rtc').text("Ora del sistema: " + date.toLocaleTimeString() + " " + date.toDateString());
                }
            });
        })
    </script>
</body>

</html>